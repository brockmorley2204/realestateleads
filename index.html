<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Find Your Top Local Agent</title>
  <style>
    :root{
      --brand:#0b66ff; --brand2:#6aa5ff; --ink:#182338; --muted:#6b768a; --ok:#2e7d32; --line:rgba(24,35,56,.08);
    }
    *{box-sizing:border-box}
    html,body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:transparent;color:var(--ink)}
    .wrap{max-width:640px;margin:44px auto;padding:0 18px}
    .card{
      background:rgba(255,255,255,.70); border:1px solid rgba(255,255,255,.45);
      border-radius:18px; padding:28px 26px 24px;
      backdrop-filter:saturate(1.1) blur(3px); -webkit-backdrop-filter:saturate(1.1) blur(3px);
      box-shadow:0 24px 60px -30px rgba(24,35,56,.35);
    }
    .hidden{display:none !important}

    /* Stepper (dots) + progress */
    .stepper{display:flex;gap:10px;justify-content:center;margin:4px 0 10px;padding:0;list-style:none}
    .stepper li{flex:0 0 auto;display:flex;align-items:center}
    .dot{width:26px;height:26px;border-radius:50%;display:grid;place-items:center;font-weight:800;font-size:12px;color:#5f6b85;background:#eef2ff;border:1px solid #d9e4ff}
    .stepper li.active .dot{background:var(--brand);border-color:var(--brand);color:#fff;box-shadow:0 6px 16px rgba(11,102,255,.35)}
    .progress{height:8px;background:#eef2f7;border-radius:999px;overflow:hidden;margin:8px 0 18px}
    .bar{height:100%;width:0;background:linear-gradient(90deg,var(--brand),var(--brand2));transition:width .25s ease}

    /* Steps */
    .step{display:none;animation:fade .22s ease}
    .step.active{display:block}
    @keyframes fade{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

    label{display:block;margin:10px 0 8px;font-weight:800}
    input{width:100%;padding:14px;border:1px solid var(--line);border-radius:12px;font-size:15px;background:#fff;transition:border .15s,box-shadow .15s}
    input:focus{outline:none;border-color:#c9d7ff;box-shadow:0 0 0 4px #eaf0ff}
    .hint{font-size:12px;color:var(--muted);margin-top:6px}
    .tiny{font-size:12px;color:#7f8aa1;margin-top:10px}
    .center{text-align:center}

    /* Buttons */
    .btns{display:flex;gap:12px;margin-top:16px}
    button{cursor:pointer;border:0;padding:12px 16px;border-radius:12px;font-weight:800;letter-spacing:.2px}
    .next{background:var(--brand);color:#fff;box-shadow:0 10px 22px -10px rgba(11,102,255,.6)}
    .back{background:#eef2f7;color:#2b3c55}
    .submit{background:var(--ok);color:#fff;box-shadow:0 10px 22px -12px rgba(46,125,50,.5)}

    /* Choice tiles (icon above, label below) */
    .choices{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:12px;margin-top:8px}
    .choice{
      display:flex; flex-direction:column; align-items:center; justify-content:center; gap:8px;
      text-align:center; padding:18px 12px; min-height:118px; width:100%;
      border:1px solid var(--line); border-radius:16px; background:#fff;
      font-weight:800; user-select:none; cursor:pointer;
      transition:transform .05s,box-shadow .12s,border-color .12s,background .12s;
    }
    .choice:hover{border-color:#cfd6e3;box-shadow:0 10px 18px -12px rgba(24,35,56,.25)}
    .choice:active{transform:translateY(1px)}
    .choice.selected{outline:2px solid var(--brand);background:#f5f8ff}
    .choice .icon{font-size:34px;line-height:1}
    .choice .label{font-size:15px}
    @media (max-width:520px){ .choices{grid-template-columns:1fr} }

    #status{margin-top:8px;min-height:16px;color:#6b768a}
    #status.saved{color:#2e7d32}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <!-- Controls (stepper + progress) -->
      <div id="controlsWrap">
        <ol class="stepper" id="stepper" aria-label="Form progress">
          <li class="active"><span class="dot" aria-label="Step 1">1</span></li>
          <li><span class="dot" aria-label="Step 2">2</span></li>
          <li><span class="dot" aria-label="Step 3">3</span></li>
          <li><span class="dot" aria-label="Step 4">4</span></li>
          <li><span class="dot" aria-label="Step 5">5</span></li>
          <li><span class="dot" aria-label="Step 6">6</span></li>
        </ol>
        <div class="progress"><div class="bar" id="bar"></div></div>
      </div>

      <form id="funnel" novalidate>
        <!-- 1. Postcode -->
        <div class="step active" data-step="1">
          <label for="postcode">Enter your postcode to be matched with the Best Local Agent</label>
          <input id="postcode" name="postcode" inputmode="numeric" minlength="4" maxlength="4"
                 autocomplete="postal-code" placeholder="e.g. 2170" required />
          <div class="btns">
            <button type="button" class="next">Next</button>
          </div>
        </div>

        <!-- 2. Property Type -->
        <div class="step" data-step="2">
          <label>Awesome! Now, what best matches your property type?</label>
          <input type="hidden" id="ptypeHidden" name="propertyType" required />
          <div class="choices" id="ptypeChoices">
            <button type="button" class="choice" data-value="House"><span class="icon">üè†</span><span class="label">House</span></button>
            <button type="button" class="choice" data-value="Unit"><span class="icon">üè¢</span><span class="label">Unit</span></button>
            <button type="button" class="choice" data-value="Townhouse"><span class="icon">üèòÔ∏è</span><span class="label">Townhouse</span></button>
            <button type="button" class="choice" data-value="Land"><span class="icon">üèûÔ∏è</span><span class="label">Land</span></button>
            <button type="button" class="choice" data-value="Other"><span class="icon">üß©</span><span class="label">Other</span></button>
          </div>
          <div class="btns" style="margin-top:12px">
            <button type="button" class="back">Back</button>
          </div>
        </div>

        <!-- 3. Price Point -->
        <div class="step" data-step="3">
          <label>Estimated price point</label>
          <input type="hidden" id="priceBandHidden" name="priceBand" required />
          <div class="choices" id="priceChoices">
            <button type="button" class="choice" data-value="0‚Äì500k"><span class="icon">üí∞</span><span class="label">0‚Äì500k</span></button>
            <button type="button" class="choice" data-value="500k‚Äì1m"><span class="icon">üí∞</span><span class="label">500k‚Äì1m</span></button>
            <button type="button" class="choice" data-value="$1m‚Äì$2m"><span class="icon">üí∞</span><span class="label">$1m‚Äì$2m</span></button>
            <button type="button" class="choice" data-value="$2m+"><span class="icon">üí∞</span><span class="label">$2m+</span></button>
          </div>
          <div class="btns" style="margin-top:12px">
            <button type="button" class="back">Back</button>
          </div>
        </div>

        <!-- 4. Address -->
        <div class="step" data-step="4">
          <label for="address">Property address</label>
          <input id="address" name="address" placeholder="e.g. 10 Example St, Liverpool NSW" required />
          <div class="btns">
            <button type="button" class="back">Back</button>
            <button type="button" class="next">Next</button>
          </div>
        </div>

        <!-- 5. Phone -->
        <div class="step" data-step="5">
          <label for="phone">Best phone number</label>
          <input id="phone" name="phone" inputmode="tel" placeholder="e.g. 0400 000 000" required />
          <div class="hint">We‚Äôll only use this to share your short-list and next steps.</div>
          <div class="btns">
            <button type="button" class="back">Back</button>
            <button type="button" class="next">Next</button>
          </div>
        </div>

        <!-- 6. Email -->
        <div class="step" data-step="6">
          <label for="email">Email for your results</label>
          <input id="email" name="email" type="email" inputmode="email" autocomplete="email" placeholder="you@example.com" required />
          <div class="tiny">By continuing, you agree we may contact you about your appraisal. You can opt out anytime.</div>
          <div class="btns">
            <button type="button" class="back">Back</button>
            <button type="submit" class="submit">See my match</button>
          </div>
        </div>

        <!-- 7. Thank you -->
        <div class="step" data-step="7">
          <div class="center" style="padding:6px 2px">
            <h2 style="margin:6px 0 8px">We‚Äôve found a match üéâ</h2>
            <p style="margin:0 0 10px;color:var(--muted)">Based on recent results in your area, <strong>Brock Morley</strong> is a great fit for your property.</p>
            <p class="tiny">We‚Äôll reach out shortly with a quick appraisal and next steps.</p>
          </div>
        </div>
      </form>

      <div id="status" class="tiny" aria-live="polite"></div>
    </div>
  </div>

  <script>
    // Your Apps Script Web App URL
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwQW0E9h0gWIN-wX6CDKUQJrjXzkfgA6sTIpqwd3-HisuiiJGXgcgSsUl5HWH8uV48/exec";
    const PROJECT = "agent-matcher-v1";
    const formSteps = 6;

    function normalizePostcode(v){ return String(v||"").replace(/\D/g,"").slice(0,4); }

    const leadId = (()=>{ const k=PROJECT+":leadId"; let id=localStorage.getItem(k);
      if(!id){ id=(crypto.randomUUID?crypto.randomUUID():String(Date.now())+Math.random().toString(16).slice(2)); localStorage.setItem(k,id); }
      return id;
    })();

    const form = document.getElementById("funnel");
    const steps = [...form.querySelectorAll(".step")];
    const bar = document.getElementById("bar");
    const statusEl = document.getElementById("status");
    const stepper = document.getElementById("stepper");
    const stepperEls = stepper.children;
    const controlsWrap = document.getElementById("controlsWrap");
    let stepIndex = 0;

    // sanitize postcode live
    const pcInput = document.getElementById("postcode");
    pcInput.addEventListener("input", ()=>{ const n=normalizePostcode(pcInput.value); if(pcInput.value!==n) pcInput.value=n; });

    function updateUI(){
      steps.forEach((s,i)=>s.classList.toggle("active", i===stepIndex));
      const pct = Math.min(100, Math.round((Math.min(stepIndex+1, formSteps)/formSteps)*100));
      bar.style.width = pct + "%";
      [...stepperEls].forEach((li,i)=>li.classList.toggle("active", i===Math.min(stepIndex, formSteps-1)));

      // Hide all chrome on step 1; on step 2 hide only the stepper (keep the progress bar)
      const hideAllChrome = (stepIndex === 0);
      controlsWrap.classList.toggle("hidden", hideAllChrome);
      stepper.classList.toggle("hidden", stepIndex < 2);
    }
    function showStep(i){ stepIndex=Math.max(0,Math.min(i,steps.length-1)); updateUI(); }

    function getCurrentFields(){
      const step = steps[stepIndex];
      const inputs = step.querySelectorAll("input, select");
      const data = {};
      inputs.forEach(inp=>{
        let v = (inp.value || "").trim();
        if(inp.id==="postcode") v = normalizePostcode(v);
        data[inp.name || inp.id] = v;
      });
      return data;
    }

    function validForStep(){
      const step = steps[stepIndex];
      const inputs = step.querySelectorAll("input[required], select[required]");
      for(const inp of inputs){
        let v = (inp.value || "").trim();
        if(inp.id==="postcode") v = normalizePostcode(v);
        if(!v) return false;
        if(inp.type==="email"){
          inp.value = v;
          if (typeof inp.checkValidity==="function" && !inp.checkValidity()) return false;
          if (!inp.checkValidity && !/.+@.+\..+/.test(v)) return false;
        }
        if(inp.id==="postcode" && v.length!==4) return false;
      }
      return true;
    }

    function savePartial(eventType){
      const payload = {
        leadId, event:eventType, stepNumber:stepIndex+1,
        answers:getCurrentFields(), userAgent:navigator.userAgent,
        screen:{w:innerWidth,h:innerHeight,dpr:devicePixelRatio||1},
        ts:new Date().toISOString()
      };
      const json = JSON.stringify(payload);
      let sent=false;
      try{ fetch(WEBHOOK_URL,{method:"POST",mode:"no-cors",body:json,keepalive:true}); sent=true; }
      catch(e){ try{ if(navigator.sendBeacon){ const b=new Blob([json],{type:"text/plain"}); navigator.sendBeacon(WEBHOOK_URL,b); sent=true; } }catch(_){} }
      statusEl.textContent = sent ? "Saved." : "Working offline‚Äîwill retry on next step.";
      statusEl.classList.toggle("saved", sent);
    }

    form.addEventListener("click",(e)=>{
      const el = e.target.closest(".choice, .next, .back");
      if(!el) return;
      if(el.classList.contains("back")){ showStep(stepIndex-1); return; }
      if(el.classList.contains("next")){
        if(!validForStep()){ statusEl.textContent="Please complete this step."; statusEl.classList.remove("saved"); return; }
        statusEl.textContent="Saving‚Ä¶"; statusEl.classList.remove("saved");
        savePartial("step"); showStep(stepIndex+1); return;
      }
      if(el.classList.contains("choice")){
        const group = el.parentElement;
        group.querySelectorAll(".choice").forEach(c=>c.classList.remove("selected"));
        el.classList.add("selected");
        if(group.id==="ptypeChoices"){ document.getElementById("ptypeHidden").value = el.dataset.value; }
        if(group.id==="priceChoices"){ document.getElementById("priceBandHidden").value = el.dataset.value; }
        statusEl.textContent="Saving‚Ä¶"; statusEl.classList.remove("saved");
        savePartial("step"); showStep(stepIndex+1);
      }
    });

    ["postcode","address","phone","email"].forEach(id=>{
      const x=document.getElementById(id); if(!x) return;
      x.addEventListener("keydown",(e)=>{
        if(e.key==="Enter"){ e.preventDefault();
          if(!validForStep()){ statusEl.textContent="Please complete this step."; statusEl.classList.remove("saved"); return; }
          statusEl.textContent="Saving‚Ä¶"; statusEl.classList.remove("saved");
          savePartial("step"); showStep(stepIndex+1);
        }
      });
    });

    form.addEventListener("submit",(e)=>{
      e.preventDefault();
      if(!validForStep()){ statusEl.textContent="Please complete this step."; statusEl.classList.remove("saved"); return; }
      statusEl.textContent="Saving‚Ä¶"; statusEl.classList.remove("saved");
      savePartial("complete"); showStep(formSteps); // thank-you
    });

    showStep(0);
  </script>
</body>
</html>
