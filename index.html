<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Find Your Top Local Agent</title>
  <style>
    :root { --text:#222; --muted:#666; --primary:#0b66ff; --ok:#2e7d32; }

    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background:transparent; color:var(--text); font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial; }
    .wrap { max-width:560px; margin:40px auto; padding:0 16px; }

    /* White card with 70% transparency, no grey page bg */
    .card {
      background: rgba(255,255,255,0.7);
      -webkit-backdrop-filter: saturate(1.1) blur(2px);
      backdrop-filter: saturate(1.1) blur(2px);
      border: 1px solid rgba(255,255,255,0.4);
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.06);
    }

    h1 { margin:0 0 6px; font-size:24px; }
    p.lead { margin:0 0 20px; color:var(--muted); }

    .progress { height:6px; width:100%; background:rgba(0,0,0,.06); border-radius:999px; overflow:hidden; margin:14px 0 20px; }
    .bar { height:100%; width:0%; background:var(--primary); transition:width .25s ease; }

    .step { display:none; }
    .step.active { display:block; }

    label { display:block; font-weight:600; margin:16px 0 8px; }
    input, select { width:100%; padding:12px 14px; border:1px solid #e1e1e8; border-radius:10px; font-size:15px; background:#fff; }
    .hint { font-size:12px; color:var(--muted); margin-top:6px; }
    .tiny { font-size:12px; color:#888; margin-top:12px; }
    .center { text-align:center; }

    .btns { display:flex; gap:12px; margin-top:18px; }
    button { cursor:pointer; border:0; padding:12px 16px; border-radius:10px; font-weight:600; }
    .next { background:var(--primary); color:#fff; }
    .back { background:#e9ecf4; color:#1b2b3a; }
    .submit { background:var(--ok); color:#fff; }

    /* Multiple-choice tiles */
    .choices { display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:6px; }
    .choice {
      display:flex; align-items:center; justify-content:center;
      border:1px solid #e1e1e8; background:#fff; border-radius:12px; padding:12px 10px;
      font-weight:700; cursor:pointer; user-select:none; text-align:center;
      transition:transform .05s ease, box-shadow .1s ease, border-color .1s ease;
    }
    .choice:hover { border-color:#cfd6e3; box-shadow:0 6px 14px rgba(0,0,0,.06); }
    .choice:active { transform:translateY(1px); }
    .choice.selected { outline:2px solid var(--primary); background:#f5f8ff; }

    @media (max-width: 460px) {
      .choices { grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <h1>Weâ€™ll find the right local agent</h1>
      <p class="lead">Answer a few quick questions. Weâ€™ll compare recent results in your area and connect you with the best fit.</p>

      <div class="progress"><div class="bar" id="bar"></div></div>

      <form id="funnel" novalidate>
        <!-- 1. Postcode -->
        <div class="step active" data-step="1">
          <label for="postcode">Whatâ€™s your propertyâ€™s postcode?</label>
          <input id="postcode" name="postcode" inputmode="numeric" autocomplete="postal-code"
                 minlength="4" maxlength="4" placeholder="e.g. 2170" required />
          <div class="hint">We use this to check recent local sales and agent performance.</div>
          <div class="btns">
            <button type="button" class="next">Next</button>
          </div>
        </div>

        <!-- 2. Property Type (multiple choice) -->
        <div class="step" data-step="2">
          <label>Property type</label>
          <!-- hidden input to store the choice -->
          <input type="hidden" id="ptypeHidden" name="propertyType" required />
          <div class="choices" id="ptypeChoices">
            <div class="choice" data-value="House">House</div>
            <div class="choice" data-value="Land">Land</div>
            <div class="choice" data-value="Unit">Unit</div>
            <div class="choice" data-value="Townhouse">Townhouse</div>
            <div class="choice" data-value="Other">Other</div>
          </div>
          <div class="btns" style="margin-top:12px">
            <button type="button" class="back">Back</button>
          </div>
        </div>

        <!-- 3. Price Point (multiple choice) -->
        <div class="step" data-step="3">
          <label>Estimated price point</label>
          <!-- hidden input to store the choice -->
          <input type="hidden" id="priceBandHidden" name="priceBand" required />
          <div class="choices" id="priceChoices">
            <div class="choice" data-value="0â€“500k">0â€“500k</div>
            <div class="choice" data-value="500kâ€“1m">500kâ€“1m</div>
            <div class="choice" data-value="$1mâ€“$2m">$1mâ€“$2m</div>
            <div class="choice" data-value="$2m+">$2m+</div>
          </div>
          <div class="btns" style="margin-top:12px">
            <button type="button" class="back">Back</button>
          </div>
        </div>

        <!-- 4. Property Address -->
        <div class="step" data-step="4">
          <label for="address">Property address</label>
          <input id="address" name="address" placeholder="e.g. 10 Example St, Liverpool NSW" required />
          <div class="btns">
            <button type="button" class="back">Back</button>
            <button type="button" class="next">Next</button>
          </div>
        </div>

        <!-- 5. Phone -->
        <div class="step" data-step="5">
          <label for="phone">Best phone number</label>
          <input id="phone" name="phone" inputmode="tel" placeholder="e.g. 0400 000 000" required />
          <div class="hint">Weâ€™ll only use this to share your short-list and next steps.</div>
          <div class="btns">
            <button type="button" class="back">Back</button>
            <button type="button" class="next">Next</button>
          </div>
        </div>

        <!-- 6. Email -->
        <div class="step" data-step="6">
          <label for="email">Email for your results</label>
          <input id="email" name="email" type="email" placeholder="you@example.com" required />
          <div class="tiny">By continuing, you agree we may contact you about your appraisal. You can opt out anytime.</div>
          <div class="btns">
            <button type="button" class="back">Back</button>
            <button type="submit" class="submit">See my match</button>
          </div>
        </div>

        <!-- Thank you -->
        <div class="step" data-step="7">
          <div class="center">
            <h2>Weâ€™ve found a match ðŸŽ‰</h2>
            <p>Based on recent results in your area, <strong>Brock Morley</strong> is a great fit for your property.</p>
            <p>Weâ€™ll reach out shortly with a quick appraisal and next steps.</p>
          </div>
        </div>
      </form>

      <div id="status" class="tiny"></div>
    </div>
  </div>

  <script>
    // Use your current Apps Script Web App URL
    const WEBHOOK_URL = "https://script.google.com/macros/s/AKfycbwQW0E9h0gWIN-wX6CDKUQJrjXzkfgA6sTIpqwd3-HisuiiJGXgcgSsUl5HWH8uV48/exec";
    const PROJECT = "agent-matcher-v1";

    // Normalize postcode to 4 digits (strip spaces/non-digits)
    function normalizePostcode(v) { return String(v || "").replace(/\D/g, "").slice(0, 4); }

    // Persistent lead ID
    const leadId = (() => {
      const k = PROJECT + ":leadId";
      let id = localStorage.getItem(k);
      if (!id) { id = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()) + Math.random().toString(16).slice(2)); localStorage.setItem(k, id); }
      return id;
    })();

    const form = document.getElementById("funnel");
    const steps = [...form.querySelectorAll(".step")];
    const bar = document.getElementById("bar");
    const statusEl = document.getElementById("status");
    let stepIndex = 0;

    // Live sanitize postcode as user types/pastes
    const pcInput = document.getElementById("postcode");
    pcInput.addEventListener("input", () => {
      const normalized = normalizePostcode(pcInput.value);
      if (pcInput.value !== normalized) pcInput.value = normalized;
    });

    function showStep(i) {
      steps.forEach((s, idx) => s.classList.toggle("active", idx === i));
      stepIndex = i;
      const pct = Math.min(100, Math.round((Math.min(i+1, 6) / 6) * 100));
      bar.style.width = pct + "%";
    }

    function getCurrentFields() {
      const step = steps[stepIndex];
      const inputs = step.querySelectorAll("input, select");
      const data = {};
      inputs.forEach(inp => {
        let val = inp.value.trim();
        if (inp.id === "postcode") val = normalizePostcode(val);
        data[inp.name || inp.id] = val;
      });
      return data;
    }

    function validForStep() {
      const step = steps[stepIndex];
      const inputs = step.querySelectorAll("input[required], select[required]");
      for (const inp of inputs) {
        let value = inp.value.trim();
        if (inp.id === "postcode") value = normalizePostcode(value);
        if (!value) return false;
        if (inp.type === "email" && !/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(value)) return false;
        if (inp.id === "postcode" && value.length !== 4) return false; // AU postcode 4 digits
      }
      return true;
    }

    // CORS-safe save: no custom headers, use no-cors, with a sendBeacon fallback
    async function savePartial(eventType) {
      const payload = {
        leadId,
        event: eventType,
        stepNumber: stepIndex + 1,
        answers: getCurrentFields(),
        userAgent: navigator.userAgent,
        screen: { w: window.innerWidth, h: window.innerHeight, dpr: window.devicePixelRatio || 1 },
        ts: new Date().toISOString()
      };
      const json = JSON.stringify(payload);
      let sent = false;
      try {
        await fetch(WEBHOOK_URL, { method: "POST", mode: "no-cors", body: json, keepalive: true });
        sent = true; // opaque response, assume success
      } catch (e) {
        try {
          if (navigator.sendBeacon) {
            const blob = new Blob([json], { type: "text/plain;charset=UTF-8" });
            navigator.sendBeacon(WEBHOOK_URL, blob);
            sent = true;
          }
        } catch (_) {}
      }
      statusEl.textContent = sent ? "Saved." : "Working offlineâ€”will retry on next step.";
    }

    form.addEventListener("click", async (e) => {
      const t = e.target;

      // Normal Next / Back buttons
      if (t.classList.contains("next")) {
        if (!validForStep()) { statusEl.textContent = "Please complete this step."; return; }
        await savePartial("step");
        showStep(stepIndex + 1);
      }
      if (t.classList.contains("back")) {
        showStep(Math.max(0, stepIndex - 1));
      }

      // Multiple-choice clicks (property type & price band)
      if (t.classList.contains("choice")) {
        // Mark selected visually within this group
        const group = t.parentElement;
        group.querySelectorAll(".choice").forEach(c => c.classList.remove("selected"));
        t.classList.add("selected");

        // Determine which hidden input to set
        if (group.id === "ptypeChoices") {
          document.getElementById("ptypeHidden").value = t.dataset.value;
        } else if (group.id === "priceChoices") {
          document.getElementById("priceBandHidden").value = t.dataset.value;
        }

        // Save immediately and advance
        await savePartial("step");
        showStep(stepIndex + 1);
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      if (!validForStep()) { statusEl.textContent = "Please complete this step."; return; }
      await savePartial("complete");
      showStep(6); // show thank-you (index 6)
    });

    showStep(0);
  </script>
</body>
</html>
